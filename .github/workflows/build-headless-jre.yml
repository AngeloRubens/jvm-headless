name: Build Headless JRE 25 (FIPS-ready)

on:
  workflow_dispatch:
    inputs:
      jdk:
        description: "Select JDK distribution"
        required: true
        type: choice
        options:
          - Temurin JDK 25 Linux x64
          - Zulu JDK 25 Linux x64
          - Semeru JDK 25 Linux x64

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Download JDK
    # ------------------------------------------------------------
    - name: Download JDK
      run: |
        case "${{ github.event.inputs.jdk }}" in
          "Temurin JDK 25 Linux x64")
            URL="https://github.com/adoptium/temurin25-binaries/releases/download/jdk-25.0.1%2B8/OpenJDK25U-jdk_x64_linux_hotspot_25.0.1_8.tar.gz"
            ;;
          "Zulu JDK 25 Linux x64")
            URL="https://cdn.azul.com/zulu/bin/zulu25.30.17-ca-jdk25.0.1-linux_x64.tar.gz"
            ;;
          "Semeru JDK 25 Linux x64")
            URL="https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-25.0.1%2B8_openj9-0.56.0/ibm-semeru-open-jdk_x64_linux_25.0.1_8_openj9-0.56.0.tar.gz"
            ;;
          *)
            echo "Unknown JDK"
            exit 1
            ;;
        esac

        mkdir jdk
        curl -L "$URL" -o jdk.tar.gz
        tar -xzf jdk.tar.gz -C jdk --strip-components=1
        echo "JAVA_HOME=$PWD/jdk" >> $GITHUB_ENV

    - name: Verify JDK
      run: |
        $JAVA_HOME/bin/java -version
        $JAVA_HOME/bin/java --list-modules | wc -l

    # ------------------------------------------------------------
    # Build headless JRE (server + FIPS-ready)
    # ------------------------------------------------------------
    - name: Build headless JRE
      run: |
        rm -rf output
        mkdir output

        MODULES="java.base,java.logging,java.xml,java.xml.crypto,java.sql,java.naming,java.security.jgss,java.security.sasl,java.rmi,jdk.crypto.ec,jdk.crypto.cryptoki,jdk.security.auth,jdk.management,jdk.management.agent,jdk.unsupported,jdk.charsets"

        $JAVA_HOME/bin/jlink \
          --module-path "$JAVA_HOME/jmods" \
          --add-modules "$MODULES" \
          --output output/headless-jre \
          --strip-debug \
          --compress=2 \
          --no-man-pages \
          --no-header-files

    # ------------------------------------------------------------
    # Strip non-runtime content
    # ------------------------------------------------------------
    - name: Strip extra files
      run: |
        rm -rf output/headless-jre/demo || true
        rm -rf output/headless-jre/sample || true
        rm -f  output/headless-jre/lib/src.zip || true
        rm -rf output/headless-jre/legal || true

    # ------------------------------------------------------------
    # Verify headless JRE runtime
    # ------------------------------------------------------------
    - name: Verify headless JRE
      run: |
        JRE=output/headless-jre

        echo "=== Java version ==="
        $JRE/bin/java -version

        echo "=== Modules ==="
        $JRE/bin/java --list-modules | sort

        echo "=== Headless check ==="
        if $JRE/bin/java --list-modules | grep -q java.desktop; then
          echo "ERROR: java.desktop present"
          exit 1
        fi
        echo "OK: headless confirmed"

    

    # ------------------------------------------------------------
    # FIPS-ready verification
    # ------------------------------------------------------------
    - name: Verify FIPS readiness
      run: |
        JRE=output/headless-jre

        echo "=== FIPS modules ==="
        $JRE/bin/java --list-modules | grep jdk.crypto.cryptoki
        $JRE/bin/java --list-modules | grep jdk.security.auth

        echo "=== Security providers ==="
        $JRE/bin/java -XshowSettings:security -version 2>&1 | grep provider

    # ------------------------------------------------------------
    # Package and upload
    # ------------------------------------------------------------
    - name: Package JRE
      run: |
        cd output
        zip -r headless-jre.zip headless-jre

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: headless-jre-fips-${{ github.event.inputs.jdk }}
        path: output/headless-jre.zip
